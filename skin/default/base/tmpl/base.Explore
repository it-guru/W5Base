<html>
<head>
<base href="%BASE%">
<link rel="stylesheet" href="../../../public/base/load/default.css"></link>
<link rel="stylesheet" href="../../../public/base/load/work.css"></link>
<link rel="stylesheet" href="../../../public/base/load/kernel.App.Web.css"></link>
<link rel="stylesheet" href="../../../public/base/load/jquery.dataTables.css"></link>
<link rel="stylesheet" href="../../../public/base/load/vis.min.css"></link>
<style>
body{
 margin:0;padding:0;
}

#main{
 margin:0px;
 padding:0px;
 border-style:solid;
 border-color:gray;
 border-width:2px;
}

#mpath{
 border-style:solid;
 xborder-color:blue;
 border-width:1px;
 margin:0px;
 padding:0px;
 vertical-align:middle;
 height:26px;
}

#mpathfirst{
 width:20px;
 line-height:25px;
 xbackground-color:gray;
 text-align:center;
 float:left;
 margin:0px;
 padding:0px;
 transform: rotate(45deg);
 font-size:20px;
}



#workspace{
 border-style:solid;
 border-color:green;
 border-width:1px;
 margin:0px;
 padding:0px;
 overflow:auto;
 background-color:#ffffff;
}

#netmap{
 border-style:solid;
 border-color:black;
 border-width:1px;
 margin:0px;
 padding:0px;
 float:left;
 overflow:auto;
}

#dbrec{
 border-style:solid;
 border-color:red;
 border-width:1px;
 margin:0px;
 padding:0px;
 width:200px;
 float:left;
 overflow:auto;
}

#cons{
 border-width:0px;
 margin:0px;
 padding:0px;
 height:55px;
 overflow:hidden;
 overflow-y:auto;
 font-family: monospace;
}
</style>


<style>


.parent {
  display: -webkit-flex;
  display: flex;
  -webkit-align-items: center;
  align-items: center;
  -webkit-justify-content:center;
  justify-content:center;
  -webkit-flex-wrap:wrap;
  flex-wrap:wrap;
  
  xbackground: #FFD54F;
  margin: 0 auto;
  width: 96%;
  margin-top:20px;
}

.parent .item,
.parent .dummyItem{
  width: 240px;
  height: 140px;
}

.parent .dummyItem {
  height:0;
  border-style: none;
}

.mtile{
  width:100%;
  height:100%;
}

.mtiletxt{
  position:relative;
  height:70%;
  margin:10px;
  background-color:#e0e0e0;
  color:#424242;
  border-style:solid;
  border-color:#e0e0e0;
  border-width:1px;
  padding:10px;
  cursor:pointer;
}

.mtiletxt span{
  font-size:18px;
  font-weight:400;
}

.mtiletxt small{
  font-size:85%;
  font-weight:400;
  position:absolute;
  right:15px;
  bottom:10px;
  color:#bdbdbd;
}

.mtiletxt:hover{
  background-color: #ffffff;
  transition: background-color 0.4s;
}

</style>


<style>
.breadcrumb-arrows li {
  display: inline-block;
  line-height: 26px;
  position: relative;
  margin:0;
  padding:0;
  padding-left:10px;
  font-size:15px;
}
.breadcrumb-arrows li:before {
  content: " ";
  height: 0;
  width: 0;
  position: absolute;
  left: -1px;
  border-style: solid;
  border-width: 13px 0 13px 8px;
  border-color: transparent transparent transparent #F3F3F3;
  z-index: 100;
}
//.breadcrumb-arrows li:last-child:before {
//  border-color: transparent;
//}
.breadcrumb-arrows a:after {
  content: " ";
  height: 0;
  width: 0;
  position: absolute;
  left: 0px;
  border-style: solid;
  border-width: 13px 0 13px 8px;
  xborder-color: transparent transparent transparent #cfc;
  border-color: transparent transparent transparent black;
  z-index: 10;
}
.breadcrumb-arrows .active a {
  font-weight: bold;
}
.breadcrumb-arrows a {
  display: block;
  xbackground: #ccc;
  padding: 0 10px;
  cursor:pointer;
}
.breadcrumb-arrows a:hover {
  font-weight: bold;
}



</style>





<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
<title>W5Explore - preBETA!</title>
</head><body><div id='main'></div></body>
<script language="JavaScript" src="../../../public/base/load/promise.js">
</script>
<script language="JavaScript" src="../../../auth/base/load/J5Base.js">
</script>
<script language="JavaScript" src="../../../public/base/load/spin.js">
</script>
<script language="JavaScript" src="../../../public/base/load/datadumper.js">
</script>
<script language="JavaScript" src="../../../public/base/load/vis.min.js">
</script>
<script language="JavaScript" src="../../../public/base/load/require.js">
</script>

<script langauge="JavaScript">






Object.defineProperty(Object.prototype, "extend", { 
    value: function(obj) {
        if (obj){
           for (var i in obj) {
              if (obj.hasOwnProperty(i)) {
                 this[i] = obj[i];
              }
           }
        }
        return(this);
    },
    enumerable : false
});










// #######################################################################

var ClassDataObjLib=new Object();
var ClassAppletLib=new Object();

// Top Class for all DataObjs
(function(window, document, undefined) {
   ClassDataObj=function(){
      console.log("top constructor ClassDataObj called",dataobj,id);
   };
   ClassDataObj.prototype.update=function(o){
      o.id=this.id;
      this.parent.update(o);
   };
   ClassApplet=function(){
      console.log("top constructor ClassApplet");
   };

})(this,document);


//////////////////////////////////////////////////////////////////////////
// Main Application Class

var W5ExploreClass=function(){
   this.console=new Object();

   this.spinnerOpts={
        lines: 13 // The number of lines to draw
      , length: 28 // The length of each line
      , width: 8 // The line thickness
      , radius: 22 // The radius of the inner circle
      , scale: 1 // Scales overall size of the spinner
      , corners: 1 // Corner roundness (0..1)
      , color: '#000' // #rgb or #rrggbb or array of colors
      , opacity: 0.25 // Opacity of the lines
      , rotate: 0 // The rotation offset
      , direction: 1 // 1: clockwise, -1: counterclockwise
      , speed: 1 // Rounds per second
      , trail: 60 // Afterglow percentage
      , fps: 20 // Frames per second when using setTimeout() 
      , zIndex: 2e9 // The z-index (defaults to 2000000000)
      , className: 'spinner' // The CSS class to assign to the spinner
      , top: '50%' // Top position relative to parent
      , left: '50%' // Left position relative to parent
      , shadow: false // Whether to render a shadow
      , hwaccel: false // Whether to use hardware acceleration
      , position: 'relative' // Element positioning
      , id:'spinner'
   };

   this.InitObjectStore=function(){
      this.node = new vis.DataSet();
      this.edge = new vis.DataSet();
   };
   this.toObjKey=function(dataobj,id){
      return(dataobj+'::'+id);
   };
   this.ResizeLayout=function(){
      this.main && $(this.main).height(1);
      this.workspace && $(this.workspace).height(1);
      this.netmap && $(this.netmap).height(1);
      this.dbrec && $(this.dbrec).height(1);

      $(this.main).outerHeight(
          $(window).innerHeight());
      if (this.console.div){
         $(this.workspace).outerHeight(
           $(this.main).innerHeight()-
           $(this.console.div).outerHeight()-
           $(this.mpath).outerHeight()-1);
      }
      else{
         $(this.workspace).outerHeight(
           $(this.main).innerHeight()-
           $(this.mpath).outerHeight()-1);
      }
      if (this.netmap){
         $(this.netmap).outerHeight(
             $(this.workspace).innerHeight());
      }
      if (this.dbrec){
         $(this.dbrec).outerHeight(
             $(this.workspace).innerHeight());
      }
      if (this.netmap){
         $(this.netmap).outerWidth(
             $(this.workspace).innerWidth()-
             $(this.dbrec).outerWidth()-1);
      }
   };

   this.LayoutBase=function(){
      this.main = document.getElementById('main');
      this.main.innerHTML = '';

      this.mpath = document.createElement('div');
      this.mpath.id = 'mpath';

      var mfirst = document.createElement('div');
      mfirst.id='mpathfirst';
      mfirst.innerHTML="\u2756";
      this.mpath.appendChild(mfirst);

      var ul = document.createElement('ul');
      $(ul).addClass("breadcrumb-arrows");
      this.mpath.appendChild(ul);

      var m = document.createElement('li');
      m.innerHTML="<a>Anwendungsexplorer</a>";
      ul.appendChild(m);

      var m = document.createElement('li');
      m.innerHTML="<a>W5Base/Darwin</a>";
      ul.appendChild(m);

      var m = document.createElement('li');
      m.innerHTML="<a>qde8hv</a>";
      ul.appendChild(m);


  //    var m = document.createElement('div');
  //    $(m).css("clear","left");
  //    this.mpath.appendChild(m);

      //this.mpath.innerHTML = 'Menü<br>xxx';
      this.main.appendChild(this.mpath);

      this.workspace = document.createElement('div');
      this.workspace.id = 'workspace';
      this.main.appendChild(this.workspace);
      //workspace.innerHTML = 'ws';

   };

   this.LayoutMenuLayer=function(){
      this.LayoutBase();
      this.ResizeLayout();
   };
   this.LayoutNetworkMap=function(){
      this.LayoutBase();
      this.netmap = document.createElement('div');
      this.netmap.id = 'netmap';
      this.workspace.appendChild(this.netmap);
      this.netmap.innerHTML = 'netmap';

      this.dbrec = document.createElement('div');
      this.dbrec.id = 'dbrec';
      this.workspace.appendChild(this.dbrec);
      this.dbrec.innerHTML = 'dbrec';

      this.console.div = document.createElement('div');
      this.console.div.id = 'cons';
      this.console.div.innerHTML = '';
      this.main.appendChild(this.console.div);
      this.ResizeLayout();
   };

   this.Init=function(){
      this.InitObjectStore();
      this.LayoutMenuLayer();
   };

   this.loadDataObjClass=function(dataobj){
      var dataobjpath=dataobj.replace('::','/');
      if (ClassDataObjLib[dataobj]){
         return(Promise.resolve(ClassDataObjLib[dataobj]));
      }
      return(
          new Promise(function(res,rej){
                $.getScript("../../"+dataobjpath+"/jsExplore", 
                function( data, textStatus, jqxhr ) {
                   console.log("itil/appl is loaded",ClassDataObjLib);
                   res(ClassDataObjLib[dataobj]);
                }).fail(function(e,parseerror){
                   if (e.readyState==0){
                      alert("fail to load script");
                   }
                   else{
                      alert("script parse error "+parseerror);
                   }
                   rej("ERROR: can not resolv dataobj "+dataobj);
                });
          })
       );
   };

   this.loadApplets=function(){
      return(
          new Promise(function(res,rej){
                $.getScript("jsApplets", 
                function( data, textStatus, jqxhr ) {
                   console.log("Applets is loaded");
                   res(1);
                }).fail(function(e,parseerror){
                   if (e.readyState==0){
                      alert("fail to load script");
                   }
                   else{
                      alert("script parse error "+parseerror);
                   }
                   console.log("fail",e);
                   rej(0);
                });
          })
       );
   };

   this.loadAppletClass=function(appletname){
     // if (ClassDataObjLib[dataobj]){
     //    return(Promise.resolve(ClassDataObjLib[dataobj]));
     // }
     // return(
     //     new Promise(function(res,rej){
     //           $.getScript("../../"+dataobjpath+"/jsExplore", 
     //           function( data, textStatus, jqxhr ) {
     //              console.log("itil/appl is loaded",ClassDataObjLib);
     //              res(ClassDataObjLib[dataobj]);
     //           }).fail(function(e){
     //              console.log("fail",e);
     //              rej("ERROR: can not resolv dataobj "+dataobj);
     //           });
     //     })
     //  );
   };


   this.addNode=function(dataobj,id,initialLabel,initialX,initialY){
      return(
          new Promise(function(res,rej){
              W5Explore.loadDataObjClass(dataobj).then(
                 function(DataObjClassPrototype){
                    var o=new DataObjClassPrototype(id,initialLabel,
                                                    initialX,initialY);
                    W5Explore.node.add(o);
                    o.parent=W5Explore.node;
                    o.app=W5Explore;
                    res(o);
                 });
          })
      )
   };


   this.console.log=function(level,text){
      var currentdate = new Date(); 
      var datetime =  currentdate.getDate() + "/"
                      + (currentdate.getMonth()+1)  + "." 
                      + currentdate.getFullYear() + " "  
                      + currentdate.getHours() + ":"  
                      + currentdate.getMinutes() + ":" 
                      + currentdate.getSeconds();
      if (this.div){
         var curConsVal=this.div.innerHTML.split("\n");
         var maxcons=10;
         if (curConsVal.length>=maxcons){
            curConsVal=curConsVal.splice(maxcons*-1);
            this.div.innerHTML=curConsVal.join("\n");
         }
         var color="<font>";
         if (level=="ERROR"){
            color="<red>";
         }
         var line=datetime+" "+color+level+": "+text+"</font><br>\n";
         line=line.replace(' ','&nbsp;');
         line=line.replace('<red>','<font color=red>');
         this.div.innerHTML+=line;
         $(this.div).scrollTop($(this.div).prop("scrollHeight"));
      }
      else{
         console.log("W5Explore",level,text);
      }
   };


   this.Config=function(){
      return(
         new Promise(function(ok,error){
            if (!this._Config){
               this._Config=createConfig({
                  useUTF8:false,
                  mode:'auth',
                  transfer:'JSON',baseUrl:'../../../'
               });
            }
            ok(this._Config);
         })
      )
   };


   this.SampleMap=function(){
      this.LayoutNetworkMap();
      var data = {
        nodes: this.node,
        edges: this.edge
      };
      var options = {
        edges: {
          font: {
            size: 12
          },
          smooth: true,
        },
        nodes: {
          level:5,
          font: {
            bold: {
              color: '#0077aa'
            }
          }
        },
        groups: {
           'itil::appl':         { level: 2 },
           'itil::swinstance':   { level: 3 },
           'itil::system':       { level: 4 }
        },
     
        layout: {
           hierarchical: {
             sortMethod: 'directed'
           }
         },
        physics: {
          enabled: false
        }
      };
      this.network = new vis.Network(this.netmap, data, options);
//  network.once("beforeDrawing", function() {
//      network.focus(2, {
//        scale: 12
//      });
//    });
    


      this.network.on("click", function (params) {
          params.event = "[original event]";
          if (params.nodes[0]){
             dbrec.innerHTML = '<h2>Click event: on '+params.nodes[0]+
                               '</h2><xmp>' + JSON.stringify(params, null, 4)+
                               "</xmp>";
          }
          else{
             dbrec.innerHTML='';
          }
      });
   };

   this.showAppletList=function(){
      $("#workspace").html("");
      var p=document.createElement('div');
      $(p).addClass("parent");
      $(this.workspace).append(p);
      var appletKey=Object.keys(ClassAppletLib);
      var appletCnt=appletKey.length;
      for(var c=0;c<appletCnt;c++){
         var k=appletKey[c];
         var e=document.createElement('div');
         $(e).addClass("item");
         var tile=document.createElement('div');
         $(tile).addClass("mtile");
         var m=document.createElement('div');
         $(m).addClass("mtiletxt");
         var htmltext="<span>"+ClassAppletLib[k].desc.label+"</span>";
         htmltext+="<p>"+ClassAppletLib[k].desc.description+"</p>";
         htmltext+="<small>"+ClassAppletLib[k].desc.sublabel+"</small>";
         $(m).html(htmltext);
         tile.appendChild(m);
         e.appendChild(tile);
         p.appendChild(e);
      }
      for(var c=0;c<appletCnt;c++){
         var e=document.createElement('div');
         $(e).addClass("dummyItem");
         p.appendChild(e);
      }
   }



   this.MainMenu=function(){
      var app=this;
      this.LayoutMenuLayer();
      var target = document.body;
      var spinner = new Spinner(W5Explore.spinnerOpts).spin(target);
      this.loadApplets().then(function(){
         app.showAppletList();
         $(".spinner").hide();
      }).catch(function(e){
         $(".spinner").hide();
         console.log("e=",e);
         $("#workspace").html("not OK");
      });
   }


   this.SampleMenu=function(){
      this.LayoutMenuLayer();
     
      var p=document.createElement('div');
      $(p).addClass("parent");
      this.workspace.appendChild(p);
      var c;
      for(c=0;c<10;c++){
         var e=document.createElement('div');
         $(e).addClass("item");
         var tile=document.createElement('div');
         $(tile).addClass("mtile");
         var m=document.createElement('div');
         $(m).addClass("mtiletxt");
         $(m).html("<span>This is "+c+"</span><p>Hallo, dies ist ein kleiner Text</p><small>infotxt</small>");
         tile.appendChild(m);
         e.appendChild(tile);
         p.appendChild(e);
      }
      for(c=0;c<10;c++){
         var e=document.createElement('div');
         $(e).addClass("dummyItem");
         p.appendChild(e);
      }

   }
};





var W5Explore=new W5ExploreClass();
W5Explore.Init();

$(window).resize(function() {
   W5Explore.ResizeLayout();
});


if (0){
   W5Explore.SampleMap();

   W5Explore.console.log("INFO","loading scenario ...");
   Promise.all([
      W5Explore.loadDataObjClass("itil::appl"),
      W5Explore.loadDataObjClass("itil::system")
   ]).then(function(){
      Promise.all([
        W5Explore.addNode("itil::appl","5275","Darwin",100,100),
        W5Explore.addNode("itil::appl","13736266300011","W5Ware",100,100),
        W5Explore.addNode("itil::system","44","TestSysA",100,100),
        W5Explore.addNode("itil::system","45","TestSysB",100,100),
        W5Explore.addNode("itil::system","46","TestSysC",100,100),
        W5Explore.addNode("itil::swinstance","13042773570001","Instance",100,100)
      ]).then(function(){
         console.log("OK, all loaded");
        W5Explore.network.fit();   
        W5Explore.console.log("INFO","finished scenario load");
      });
   });
}
else{
   W5Explore.MainMenu();
}




</script>



</html>
